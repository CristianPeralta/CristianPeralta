name: Update Chess Rating in README
env:
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
on:
  #schedule:
  #  - cron: "0 0 * * *" # Runs every day at midnight UTC
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Update README with Chess Stats
        run: |
          USERNAME="krix0s"
          URL="https://www.chess.com/callback/member/stats/$USERNAME"
          DATA=$(curl -s $URL)

          CURRENT_RATING=$(echo $DATA | jq '[.stats[].stats.rating] | max')
          MAX_RATING=$(echo $DATA | jq '[.stats[].stats.highest_rating] | max')
          DATE=$(date +"%Y-%m-%d %H:%M:%S UTC")

          # Update Chess Stats section.
          awk -v current="$CURRENT_RATING" -v max="$MAX_RATING" '
            BEGIN {inside=0}
            /<!-- CHESS_STATS_START -->/ {inside=1; print; print "      - üìà Rating actual: " current; print "      - üèÜ Rating m√°ximo: " max; next}
            /<!-- CHESS_STATS_END -->/ {inside=0}
            !inside {print}
          ' README.md > temp.md && mv temp.md README.md

          # Update last updated timestamp at the end of the README.
          awk -v date="$DATE" '
            /<!-- LAST_UPDATE -->/ {print; print "üìÖ *√öltima actualizaci√≥n:* " date; next}
            {print}
          ' README.md > temp.md && mv temp.md README.md


      - name: Configure Git
        run: |
          git config --local user.name "CristianPeralta"
          git config --local user.email "miegmail@gmail.com"
          git remote set-url origin https://x-access-token:$GH_TOKEN@github.com/CristianPeralta/CristianPeralta.git

      - name: Debug GH_TOKEN
        run: |
          echo "Checking authentication..."
          git ls-remote https://x-access-token:$GH_TOKEN@github.com/CristianPeralta/CristianPeralta.git

      - name: Debug GH_TOKEN literal
        run: |
          echo "Checking authentication..."
          git ls-remote https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/CristianPeralta/CristianPeralta.git

      - name: Debug Git Remote
        run: git remote -v

      - name: Commit and push
        run: |
          git add README.md
          git commit -m "Automatic update: $CURRENT_RATING / $MAX_RATING"
          git push https://x-access-token:$GH_TOKEN@github.com/CristianPeralta/CristianPeralta.git
